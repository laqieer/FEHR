- pipeline: "Build & Release"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/tags/*"
  ref_type: "WILDCARD"
  trigger_condition: "ALWAYS"
  actions:
    - action: "Build & Release"
      type: "BUILD"
      working_directory: "/buddy/fe7-jp-stunning-tribble"
      docker_image_name: "devkitpro/devkitarm"
      docker_image_tag: "latest"
      execute_commands:
        - "if [ ! -d \"cmake-3.16.4-Linux-x86_64\" ]; then wget https://github.com/Kitware/CMake/releases/download/v3.16.4/cmake-3.16.4-Linux-x86_64.tar.gz; tar -zxvf cmake-3.16.4-Linux-x86_64.tar.gz; fi"
        - "PATH=`pwd`/cmake-3.16.4-Linux-x86_64/bin:$PATH ./configure"
        - "cd build && make"
        - "if [ ! -d \"floating\" ]; then wget https://dl.smwcentral.net/11474/floating.zip; unzip floating.zip; chmod +x floating/flips-linux; fi"
        - "tag=$(git describe --tags `git rev-list --tags --max-count=1`)"
        - "floating/flips-linux -c -b ../rom/fe7-jp.gba fe7-jp-stunning-tribble.gba FEHR$tag.bps"
        - "github-release upload --owner laqieer --repo fe7-jp-stunning-tribble --tag \"$tag\" --name \"$tag\" --body \"Released automatically by Buddy CI pipeline.\" FEHR$tag.bps"
      setup_commands:
        - "apt-get update && apt-get -y install unzip libgtk-3-0 libgomp1 nodejs npm"
        - "npm install -g github-release-cli"
      mount_filesystem_path: "/buddy/fe7-jp-stunning-tribble"
      shell: "BASH"
      trigger_condition: "ALWAYS"
